<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
</head>
<body>
    <div class="container">
        <h1 class="alert alert-secondary p-2 text-center mb-3">
            Shop Items
        </h1>

        <div id="searchBar" class="row g-2 align-items-end mb-3">
            <div class="col-12 col-md-6">
                <label for="searchText" class="form-label">Item name</label>
                <input id="searchText" class="form-control" type="text" placeholder="Search by name…" />
            </div>

            <div class="col-12 col-md-4">
                <label for="categorySelect" class="form-label">Category</label>
                <select id="categorySelect" name="CategoryId" class="form-select">
                    <option value="">All categories</option>
                </select>
            </div>

            <div class="col-12 col-md-2">
                <button id="searchBtn" type="button" class="btn btn-primary w-100" onclick="loadItems()">Search</button>
            </div>
        </div>

        <div class="row justify-content-start mt-2 " id="cardRow">
            <div class="col-4 md-2 d-none" id="card">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Card title</h5>
                        <p class="card-text">Card text</p>
                        <p class="card-text">Price</p>

                    </div>
                    <img src="..." class="card-img-top" alt="..." />
                </div>
            </div>

        </div>
    </div>
    <!-- Inline Script -->
    <script>

        fetch('/api/ParentCategoriesWebAPI').then((response) => response.json()).then(data => {
            let select = document.querySelector('select[name="CategoryId"]');

            data.forEach(c => {
                let option = document.createElement("option");
                option.value = c.categoryId;
                option.innerText = c.categoryName;
                select.appendChild(option);
            })
        })

        async function loadItems() {
            let row = document.getElementById("cardRow");
            let template = row.querySelector("#card");

            [...row.children].forEach(el => { if (el !== template) el.remove(); });

            const searchText = document.getElementById('searchText').value;
            const categoryId = document.getElementById('categorySelect').value;
            console.log(categoryId);

            const qs = new URLSearchParams();
            if (searchText) qs.set("SearchText", searchText);
            if (categoryId) qs.set("CategoryID", categoryId);
            const url = qs.toString() ? `/api/ItemsWebAPI?${qs}` : `/api/ItemsWebAPI`;

            fetch(url).then((response) => response.json()).then(items => {
                items.forEach(item => {
                    buildItems(item);
                })
            }).catch((e) => console.error(e));

            function buildItems(data) {
                const col = template.cloneNode(true);

                col.classList.remove('d-none');
                col.querySelector("h5").innerText = data.itemName;
                let pList = col.querySelectorAll('p');
                pList[0].innerText = data.itemDescription;
                pList[1].innerText = data.itemCost;

                let image = col.querySelector("img");
                if (data.itemImage) {
                    image.src = data.itemImage;
                    image.alt = data.itemDescription;
                } else {
                    image.removeAttribute("src");
                    image.alt = "";
                }

                row.appendChild(col);
            }
        }

        loadItems();

    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
</body>
</html>